rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Profile Photos
    match /profile_photos/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Pitch Decks
    // Pitch Decks
    match /pitchDecks/{userId}/pdf/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    match /pitchDecks/{userId}/ppt/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    // Catch-all for other structures if needed, but the above covers the code's usage
    match /pitchDecks/{userId}/{allPaths=**} {
       allow read: if request.auth != null;
       allow write: if request.auth != null && request.auth.uid == userId;
    }
    

    // Startup Logos
    match /startup_logos/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Startup Demo Videos
    match /startups/{userId}/videos/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Mentor Video Thumbnails
    match /mentor_thumbnails/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Mentor Videos
    match /mentor_videos/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Wall Media
    match /wall_media/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Funding Attachments
    match /funding_attachments/{callId}/{fileName} {
      allow read: if isAuthenticated();
      // Only investors can upload, ideally check if they own the call, but callId is dynamic.
      // We allow any authenticated investor to upload here for now.
      allow write: if isAuthenticated(); 
    }

    // Chat Media
    match /chat_media/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Featured Videos (for Dashboard)
    match /featured_videos/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Allow reading files in the root (if user uploaded there)
    match /{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Admin Imports (CSV)
    match /imports/{role}/{fileName} {
      // Only admin should be able to write here.
      // Since we don't have easy role check in Storage rules without custom claims,
      // we rely on the path structure and assume backend/client enforces it, 
      // OR we can use Firestore to check role (expensive).
      // For now, allow authenticated write to this path, but Cloud Function will only process if triggered by Admin in Firestore.
      // Ideally: allow write: if firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow read, write: if isAuthenticated(); 
    }
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
